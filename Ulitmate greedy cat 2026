<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Greedy Cat Max â€” Ultimate (Ø°Ø§ÙƒØ±Ø© 300 & ØµØ¯Ù‘ Ø§Ù„Ø¬Ø¹ÙÙ„Ø©)</title>
<style>
:root{
  --bg:#071018; --panel:#0b1416; --accent:#ffd548;
  --meat:#ff6b6b; --veg:#6fe08a; --ext:#4fc3f7; --muted:#9fb0bb; --text:#e9f2f5;
  --danger:#ffb86b;
}
*{box-sizing:border-box}
body{margin:0;font-family: "Cairo", Tahoma, Arial, sans-serif;background:linear-gradient(180deg,var(--bg),#021018);color:var(--text);padding:12px}
h1{margin:6px 0 12px;color:var(--accent);text-align:center;font-size:1.3rem}
.container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 460px;gap:14px}
.panel{background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 8px 30px #0008}
.grid{display:grid;grid-template-columns:repeat(4,86px);gap:12px;justify-content:center}
.item{background:#081217;border-radius:10px;padding:10px;cursor:pointer;border:2px solid transparent;text-align:center;font-size:1.6rem;height:86px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.item.selected{border-color:var(--accent);box-shadow:0 8px 26px #ffd54822}
.hot-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:8px}
.hot{padding:8px 10px;border-radius:9px;background:#071216;border:2px solid transparent;cursor:pointer}
.hot.active{border-color:#ff9800;box-shadow:0 8px 18px #ff980030}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.chip{padding:6px 10px;border-radius:8px;background:#07161a;color:var(--muted);font-weight:700}
.chip.meat{border:1px solid rgba(255,107,107,0.12);color:var(--meat)}
.chip.veg{border:1px solid rgba(111,224,138,0.12);color:var(--veg)}
.chip.ext{border:1px solid rgba(79,195,247,0.12);color:var(--ext)}
.btn{background:var(--accent);border:none;padding:9px 12px;border-radius:8px;color:#081217;font-weight:800;cursor:pointer}
.ghost{background:transparent;border:1px solid #123;padding:8px 10px;color:var(--muted);border-radius:8px;cursor:pointer}
.small{font-size:.92rem;color:var(--muted)}
.title{font-weight:800;color:var(--accent);margin-bottom:8px}
.bar{height:10px;border-radius:8px;background:#061216;margin-top:6px;overflow:hidden}
.bar-inner{height:100%}
.warning{color:var(--danger);font-weight:800}
.danger{color:#ff8a65;font-weight:900}
.stats{display:flex;gap:8px;flex-wrap:wrap}
.stat{background:#07171a;padding:8px;border-radius:8px;min-width:120px;text-align:center}
.right-col{display:flex;flex-direction:column;gap:12px}
@media(max-width:980px){.container{grid-template-columns:1fr}.grid{grid-template-columns:repeat(4,92px)}}
</style>
</head>
<body>
<h1>Greedy Cat Max â€” Ultimate Edition (Ø°Ø§ÙƒØ±Ø© 300 & ØµØ¯Ù‘ Ø§Ù„Ø¬Ø¹ÙÙ„Ø©)</h1>

<div class="container">
  <!-- Ø§Ù„ÙŠØ³Ø§Ø±: Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù„Ø¹Ø¨ -->
  <div class="panel">
    <div class="title">ØªØ­ÙƒÙ… Ø³Ø±ÙŠØ¹</div>
    <div class="hot-row" id="hotRow" title="Ø§Ø¶ØºØ· Ù„ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Hot"></div>

    <div class="grid" id="grid"></div>

    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button class="btn" id="autoBtn">ğŸ”® ØªÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
      <button class="ghost" id="clearBtn">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</button>
      <button class="ghost" id="exportBtn">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
      <button class="ghost" id="importBtn">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
    </div>

    <div style="margin-top:12px">
      <div class="title">Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¢Ø®Ø± 10)</div>
      <div id="currentBar" class="row"></div>
      <div class="small" id="countInfo">Ø§Ù„Ø°Ø§ÙƒØ±Ø©: 0 / 300</div>
    </div>
  </div>

  <!-- Ø§Ù„ÙŠÙ…ÙŠÙ†: ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆÙ†ØªØ§Ø¦Ø¬ -->
  <div class="right-col">
    <div class="panel">
      <div class="title">Ù…Ù„Ø®Øµ Ø°ÙƒÙŠ & Ø¥Ù†Ø°Ø§Ø±Ø§Øª</div>
      <div class="row">
        <div class="stat"><div class="small">Ø§Ù„Ù…ÙˆØ¬Ø©</div><div id="waveInfo">-</div></div>
        <div class="stat"><div class="small">ØªØ¶Ù„ÙŠÙ„</div><div id="trickInfo">â€”</div></div>
        <div class="stat"><div class="small">Hot</div><div id="hotInfo">â€”</div></div>
      </div>
      <div style="margin-top:10px">
        <div id="earlyAlert" class="warning"></div>
        <div id="strongAlert" class="danger" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="panel">
      <div class="title">Ø£ÙØ¶Ù„ 5 â€” Ù…Ø¹ Ù†Ø³Ø¨Ø© Ø§Ù„Ø«Ù‚Ø©</div>
      <div id="top5List"></div>
      <div id="top5Bar" style="margin-top:8px"></div>
      <div id="balanceNote" class="small" style="margin-top:8px"></div>
    </div>

    <div class="panel">
      <div class="title">Ø¨Ø¯Ø§Ø¦Ù„ Ø°ÙƒÙŠØ© (2) & ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…ÙØ§Ø¬Ø£Ø©</div>
      <div id="alternatives" class="row"></div>
      <div id="surprise" style="margin-top:8px"></div>
    </div>

    <div class="panel">
      <div class="title">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ø¢Ø®Ø± 300)</div>
      <div id="statsArea" class="small"></div>
      <div style="margin-top:8px" class="small muted">ØªØ³ØªØ·ÙŠØ¹ ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¹Ø¨Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰.</div>
    </div>
  </div>
</div>

<script>
/* =====================
   Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ø±ÙØ§Ù‚
   ===================== */
const meats = [
  {emoji:'ğŸ”', name:'Ø¯Ø¬Ø§Ø¬'}, {emoji:'ğŸ‘', name:'ØºÙ†Ù…'},
  {emoji:'ğŸŸ', name:'Ø³Ù…Ùƒ'}, {emoji:'ğŸ¦', name:'Ø¬Ù…Ø¨Ø±ÙŠ'}
];
const veggies = [
  {emoji:'ğŸ¥•', name:'Ø¬Ø²Ø±'}, {emoji:'ğŸŒ½', name:'Ø°Ø±Ø©'},
  {emoji:'ğŸ…', name:'Ø·Ù…Ø§Ø·Ù…'}, {emoji:'ğŸŒ¶ï¸', name:'ÙÙ„ÙÙ„'}
];
const allItems = meats.concat(veggies);
const all = allItems.map(i=>i.emoji);

const companions = {
  'ğŸ”':['ğŸŸ','ğŸ‘'],'ğŸŸ':['ğŸ¦','ğŸ”'],'ğŸ‘':['ğŸ”','ğŸŸ'],'ğŸ¦':['ğŸŸ','ğŸ”'],
  'ğŸ¥•':['ğŸŒ½','ğŸ…'],'ğŸŒ½':['ğŸ¥•','ğŸŒ¶ï¸'],'ğŸ…':['ğŸ¥•','ğŸŒ¶ï¸'],'ğŸŒ¶ï¸':['ğŸ…','ğŸŒ½']
};

/* ================
   Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø©
   ================ */
const MEMORY_MAX = 300;
let memory = JSON.parse(localStorage.getItem('gc_ultimate_memory') || '[]');
if(!Array.isArray(memory)) memory = [];
let hotManual = JSON.parse(localStorage.getItem('gc_ultimate_hot') || '{}');
if(!hotManual) hotManual = {};

/* DOM */
const grid = document.getElementById('grid');
const hotRow = document.getElementById('hotRow');
const currentBar = document.getElementById('currentBar');
const countInfo = document.getElementById('countInfo');
const top5List = document.getElementById('top5List');
const alternativesDiv = document.getElementById('alternatives');
const surpriseDiv = document.getElementById('surprise');
const waveInfo = document.getElementById('waveInfo');
const trickInfo = document.getElementById('trickInfo');
const hotInfo = document.getElementById('hotInfo');
const earlyAlert = document.getElementById('earlyAlert');
const strongAlert = document.getElementById('strongAlert');
const top5Bar = document.getElementById('top5Bar');
const balanceNote = document.getElementById('balanceNote');
const statsArea = document.getElementById('statsArea');

const autoBtn = document.getElementById('autoBtn');
const clearBtn = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');

/* ======= Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ======= */
function renderGrid(){
  grid.innerHTML='';
  all.forEach(e=>{
    const it = allItems.find(x=>x.emoji===e);
    const d = document.createElement('div');
    d.className='item';
    d.innerHTML = `<div style="font-size:1.3rem">${e}</div><div class="small">${it.name}</div>`;
    d.onclick = ()=> pushChoice(e);
    grid.appendChild(d);
  });
}
function renderHotRow(){
  hotRow.innerHTML='';
  all.forEach(e=>{
    const d = document.createElement('div');
    d.className = 'hot' + (hotManual[e] ? ' active' : '');
    d.textContent = e;
    d.onclick = ()=>{
      hotManual[e] = !hotManual[e];
      localStorage.setItem('gc_ultimate_hot', JSON.stringify(hotManual));
      renderHotRow(); updateAll();
    };
    hotRow.appendChild(d);
  });
}

/* ============= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø°Ø§ÙƒØ±Ø© ============= */
function pushChoice(e){
  memory.push({emoji:e, t:Date.now()});
  if(memory.length>MEMORY_MAX) memory = memory.slice(-MEMORY_MAX);
  localStorage.setItem('gc_ultimate_memory', JSON.stringify(memory));
  updateAll();
}
function clearMemory(){
  if(!confirm('Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) return;
  memory = []; localStorage.removeItem('gc_ultimate_memory');
  hotManual = {}; localStorage.removeItem('gc_ultimate_hot');
  renderHotRow(); updateAll();
}

/* ===== Ø£Ø¯ÙˆØ§Øª ØªØ­Ù„ÙŠÙ„ ===== */
function lastN(n){ return memory.slice(-n).map(m=>m.emoji); }
function countMemory(){
  const c={};
  memory.forEach(m=> c[m.emoji] = (c[m.emoji]||0)+1);
  return c;
}
function isMeat(e){ return meats.some(m=>m.emoji===e); }
function isVeg(e){ return veggies.some(v=>v.emoji===e); }
function getName(e){ const it = allItems.find(i=>i.emoji===e); return it?it.name:''; }

/* Wave analysis (Ø¢Ø®Ø± 12) */
function analyzeWave(){
  const arr = lastN(12);
  if(arr.length===0) return {type:null, len:0};
  let curType = isMeat(arr[0]) ? 'meat' : 'veg';
  let curLen=1, maxLen=1, maxType=curType;
  for(let i=1;i<arr.length;i++){
    const t = isMeat(arr[i]) ? 'meat' : 'veg';
    if(t===curType){ curLen++; if(curLen>maxLen){ maxLen=curLen; maxType=curType; } }
    else { curType=t; curLen=1; }
  }
  return {type:maxType, len:maxLen};
}

/* ÙƒØ´Ù ØªØ¶Ù„ÙŠÙ„: Ø¢Ø®Ø± 3 Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù†ÙˆØ¹ => ØªØ¶Ù„ÙŠÙ„ Ù…Ù…ÙƒÙ† */
function detectTrick(){
  const arr = lastN(3);
  if(arr.length<3) return {trick:false, reason:''};
  const same = arr.every(x=> isMeat(x) === isMeat(arr[0]));
  if(same) return {trick:true, reason: isMeat(arr[0]) ? 'Ø³Ù„Ø³Ù„Ø© Ù„Ø­ÙˆÙ… Ù‚ØµÙŠØ±Ø© (Ø±Ø¨Ù…Ø§ ØªØ¶Ù„ÙŠÙ„)' : 'Ø³Ù„Ø³Ù„Ø© Ø®Ø¶Ø§Ø± Ù‚ØµÙŠØ±Ø© (Ø±Ø¨Ù…Ø§ ØªØ¶Ù„ÙŠÙ„)'};
  return {trick:false, reason:''};
}

/* Ù…Ø¤Ø´Ø± Ù…Ø¨ÙƒØ± Ù„Ù„Ø¬Ø¹ÙÙ„Ø© (Ù…Ù† Ø£ÙˆÙ„ 3 Ù…ØªØªØ§Ù„ÙŠØ©) + Ù…Ø³ØªÙˆÙŠØ§Øª */
function detectEarlyFraud(counts){
  // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø¹Ù†ØµØ± Ø¸Ù‡Ø± Ù…ØªØªØ§Ù„ÙŠÙ‹Ø§ k Ù…Ø±Ø§Øª Ù…Ø¤Ø®Ø±Ø§Ù‹ Ø¯Ø§Ø®Ù„ Ø¢Ø®Ø± 10
  const arr = lastN(10);
  if(arr.length===0) return {level:0, emoji:null, message:''};
  // Ø§Ø­Ø³Ø¨ Ø£Ø·ÙˆÙ„ ØªØ³Ù„Ø³Ù„ Ù…ØªØªØ§Ù„ÙŠ Ù„Ø¢Ø®Ø± Ø¹Ù†ØµØ±
  const last = arr[arr.length-1];
  let seq=1;
  for(let i=arr.length-2;i>=0;i--){
    if(arr[i]===last) seq++; else break;
  }
  // Levels: seq>=3 -> ØªØ­Ø°ÙŠØ± Ù…Ø¨ÙƒØ±; seq>=5 -> Ø¹Ø§Ù„ÙŠ; seq>=7 -> Ø®Ø·ÙŠØ±
  if(seq>=7) return {level:3, emoji:last, message:`ğŸš¨ Ø®Ø·Ø± Ø¬Ø¹ÙÙ„Ø© Ù‚ÙˆÙŠ: ${last} Ù…ØªÙƒØ±Ø± ${seq} Ù…Ø±Ø§Øª Ù…ØªØªØ§Ø¨Ø¹Ø©`};
  if(seq>=5) return {level:2, emoji:last, message:`âš ï¸ Ø¬Ø¹ÙÙ„Ø© Ø¹Ø§Ù„ÙŠØ©: ${last} Ù…ØªÙƒØ±Ø± ${seq} Ù…Ø±Ø§Øª`};
  if(seq>=3) return {level:1, emoji:last, message:`ğŸ”„ ØªØ­Ø°ÙŠØ± Ù…Ø¨ÙƒØ±: ${last} Ù…ØªÙƒØ±Ø± ${seq} Ù…Ø±Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ©`};
  return {level:0, emoji:null, message:''};
}

/* Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø§Øª ÙˆØ«Ù‚Ø© Ù„ÙƒÙ„ ØµÙ†Ù */
function computeScores(){
  const counts = countMemory(); // absolute counts in memory
  // lastIndex: Ø®Ø·ÙˆØ§Øª Ù…Ù†Ø° Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± (0 = Ø¢Ø®Ø± Ø¹Ù†ØµØ±)
  const lastIndex = {};
  all.forEach(e=> lastIndex[e] = -1);
  for(let i=memory.length-1;i>=0;i--){
    const em = memory[i].emoji;
    if(lastIndex[em]===-1) lastIndex[em] = memory.length-1 - i;
  }
  all.forEach(e=>{ if(lastIndex[e]===-1) lastIndex[e] = 999; }); // ØºØ§Ø¦Ø¨ Ø·ÙˆÙŠÙ„
  // raw score composition
  const raw = {};
  all.forEach(e=>{
    let s = 0;
    // ØªÙƒØ±Ø§Ø± Ù…Ù‡Ù…
    s += (counts[e] || 0) * 12;
    // Hot ÙŠØ¯ÙˆÙŠ Ù‚ÙˆÙŠ
    s += (hotManual[e] ? 120 : 0);
    // Ø­Ø¯Ø§Ø«Ø©: ÙƒÙ„Ù…Ø§ Ø¸Ù‡Ø± Ù‚Ø±ÙŠØ¨Ù‹Ø§ Ø²Ø§Ø¯
    const rec = lastIndex[e];
    if(rec < 999) s += Math.max(0, 40 - rec); else s += 6;
    // ØºÙŠØ§Ø¨ Ø·ÙˆÙŠÙ„ ÙŠØ¹Ø·Ù‰ Ø¯ÙØ¹Ø© ØµØºÙŠØ±Ø© (Ù„Ù„Ù…ÙØ§Ø¬Ø£Ø©)
    if(lastIndex[e] >= 20) s += 18;
    raw[e] = s;
  });
  // Ù…Ù†Ø¹/ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø´ÙŠØ§Ø¡ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ø¨Ø´Ø¯Ø© (Ø¬Ø¹ÙÙ„Ø© Ù…ÙˆÙ‚ÙˆÙØ© Ø§Ùˆ ØªÙ‚Ù„Ù„)
  // Ù„Ùˆ ØµÙ†Ù ØªÙƒØ±Ø± >= 10 Ø¯Ø§Ø®Ù„ Ø§Ù„Ø°Ø§ÙƒØ±Ø© => Ù†Ø®ÙØ¶ ÙˆØ²Ù†Ù‡
  Object.entries(counts).forEach(([e,c])=>{
    if(c >= 10) raw[e] = Math.floor(raw[e] * 0.35); // Ù†Ø®ÙØ¶ Ø¨Ø´Ø¯Ø©
    else if(c >= 7) raw[e] = Math.floor(raw[e] * 0.6); // Ù†Ø®ÙØ¶
  });
  // normalize -> confidence %
  const total = Object.values(raw).reduce((a,b)=>a+b,0) || 1;
  const conf = {};
  all.forEach(e=>{
    conf[e] = Math.round((raw[e]/total)*100);
  });
  return {raw, conf, counts, lastIndex};
}

/* Ø§Ø®ØªÙŠØ§Ø± Top5 Ø°ÙƒÙŠ Ù…Ø¹ ØªÙˆØ§Ø²Ù† Ù…Ø±Ù† */
function computeTop5(){
  const {raw, conf, counts, lastIndex} = computeScores();
  const sorted = all.slice().sort((a,b)=> conf[b] - conf[a] );
  // Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…ÙˆØ¬Ø©
  const wave = analyzeWave();
  const waveStrong = wave.len >= 4;
  // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒØ±Ø§Ø± Ù„Ø£Ù†ÙˆØ§Ø¹
  const meatTotal = all.filter(isMeat).reduce((s,e)=> s + (counts[e]||0), 0);
  const vegTotal  = all.filter(isVeg).reduce((s,e)=> s + (counts[e]||0), 0);
  let prefer = null;
  if(vegTotal > meatTotal) prefer='veg';
  else if(meatTotal > vegTotal) prefer='meat';
  else prefer = wave.type || (isVeg(sorted[0]) ? 'veg' : 'meat');

  // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø±: Ø¹Ø§Ø¯Ø© 3+2ØŒ ÙˆØ¥Ø°Ø§ Ù…ÙˆØ¬Ø© Ù‚ÙˆÙŠØ© Ø¬Ø¯Ø§Ù‹ Ù†Ø³Ù…Ø­ 4+1
  const pickBy = (type, n, exclude=[])=>{
    return sorted.filter(e=> (type==='meat'?isMeat(e):isVeg(e)) && !exclude.includes(e)).slice(0,n);
  };

  let top5 = [];
  if(prefer==='veg'){
    top5 = pickBy('veg',3).concat(pickBy('meat',2));
    if(waveStrong && (conf[top5[0]] - conf[top5[3]] > 18)){
      const alt = pickBy('veg',4).concat(pickBy('meat',1));
      if(alt.length>=5) top5 = alt.slice(0,5);
    }
  } else {
    top5 = pickBy('meat',3).concat(pickBy('veg',2));
    if(waveStrong && (conf[top5[0]] - conf[top5[3]] > 18)){
      const alt = pickBy('meat',4).concat(pickBy('veg',1));
      if(alt.length>=5) top5 = alt.slice(0,5);
    }
  }
  // Ø¶Ù…Ø§Ù† Ø§Ù„Ø·ÙˆÙ„ 5
  const used = new Set(top5);
  for(const e of sorted){ if(top5.length>=5) break; if(!used.has(e)) top5.push(e); }

  // Ø¨Ø¯Ø§Ø¦Ù„ Ø°ÙƒÙŠØ©: 1- Ù…Ø¶Ø§Ø¯ Ù„Ù„ØªØ¶Ù„ÙŠÙ„ØŒ 2- Ø±ÙÙŠÙ‚ Hot Ø£Ùˆ underdog
  const alternatives = [];
  const trick = detectTrick();
  if(trick.trick){
    const last = lastN(1)[0];
    const oppositeType = isMeat(last) ? 'veg' : 'meat';
    const opp = sorted.find(e=> (oppositeType==='meat'?isMeat(e):isVeg(e)));
    if(opp) alternatives.push(opp);
  }
  // companion for first Hot
  const hotList = Object.keys(hotManual).filter(k=>hotManual[k]);
  if(hotList.length){
    const cands = companions[hotList[0]] || [];
    cands.forEach(c=>{ if(alternatives.length<2 && !alternatives.includes(c)) alternatives.push(c); });
  }
  // fill from underdogs (least counts)
  const least = all.slice().sort((a,b)=> (counts[a]||0) - (counts[b]||0));
  for(const e of least){
    if(alternatives.length>=2) break;
    if(!top5.includes(e) && !alternatives.includes(e)) alternatives.push(e);
  }

  // early fraud detection (based on detectEarlyFraud)
  const early = detectEarlyFraud(counts);

  return {top5, alternatives, conf, raw, counts, lastIndex, wave, trick, early};
}

/* ============ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ============ */
function updateAll(){
  // current bar (last 10)
  const last10 = lastN(10);
  currentBar.innerHTML = last10.length ? last10.map(e=>`<span class="chip ${isMeat(e)?'meat':'veg'}">${e} ${getName(e)}</span>`).join(' ') : '<span class="small">ÙØ§Ø±Øº</span>';
  countInfo.textContent = `${memory.length} / ${MEMORY_MAX}`;

  // hot info
  const hotList = Object.keys(hotManual).filter(k=>hotManual[k]);
  document.getElementById('hotInfo').textContent = hotList.length ? hotList.join(' ') : 'â€”';

  // compute
  const {top5, alternatives, conf, raw, counts, lastIndex, wave, trick, early} = computeTop5();

  // top5 render with confidence bars
  top5List.innerHTML = top5.map(e=>{
    const type = isMeat(e)?'meat':'veg';
    const name = getName(e);
    const percent = conf[e] || 0;
    const width = Math.max(6, percent);
    return `<div style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><span class="chip ${type}">${e} ${name}</span></div>
        <div><strong>${percent}%</strong></div>
      </div>
      <div class="bar"><div class="bar-inner" style="width:${width}%;background:${type==='meat'?'var(--meat)':'var(--veg)'}"></div></div>
    </div>`;
  }).join('');

  top5Bar.innerHTML = top5.map(e=>`${e} ${getName(e)} (${conf[e]}%)`).join('  ');

  // alternatives
  alternativesDiv.innerHTML = alternatives.length ? alternatives.map(e=>`<span class="chip ext">${e} ${getName(e)}</span>`).join(' ') : '<span class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';

  // surprise: prioritized missing (long gap) OR underdog
  const missing = Object.entries(lastIndex).filter(([e,idx])=> idx>=25 ).map(x=>x[0]);
  let surpriseText = '';
  if(missing.length){
    surpriseText = `ğŸ¯ ØªÙˆÙ‚Ø¹ Ù…ÙØ§Ø¬Ø£Ø© (ØºØ§Ø¦Ø¨ Ø·ÙˆÙŠÙ„): <span class="chip ext">${missing[0]} ${getName(missing[0])}</span>`;
  } else {
    const leastByCount = Object.entries(counts).sort((a,b)=>a[1]-b[1]).map(x=>x[0]);
    if(leastByCount.length) surpriseText = `ğŸ¯ ØªÙˆÙ‚Ø¹ Ù…ÙØ§Ø¬Ø£Ø©: <span class="chip ext">${leastByCount[0]} ${getName(leastByCount[0])}</span>`;
    else surpriseText = `ğŸ¯ ØªÙˆÙ‚Ø¹ Ù…ÙØ§Ø¬Ø£Ø©: <span class="chip ext">${top5[top5.length-1]} ${getName(top5[top5.length-1])}</span>`;
  }
  surpriseDiv.innerHTML = surpriseText;

  // wave & trick
  waveInfo.textContent = wave.type ? `${wave.type==='veg'?'Ù…ÙˆØ¬Ø© Ø®Ø¶Ø§Ø±':'Ù…ÙˆØ¬Ø© Ù„Ø­ÙˆÙ…'} Ø¨Ø·ÙˆÙ„ ${wave.len}` : '-';
  trickInfo.textContent = trick.trick ? trick.reason : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¶Ù„ÙŠÙ„ ÙˆØ§Ø¶Ø­';

  // early fraud alerts
  if(early.level>=3){
    strongAlert.textContent = early.message;
    earlyAlert.textContent = '';
  } else {
    strongAlert.textContent = '';
    earlyAlert.textContent = early.level>=1 ? early.message : '';
  }

  // balance note
  const meatTotal = all.filter(isMeat).reduce((s,e)=> s + (counts[e]||0), 0);
  const vegTotal  = all.filter(isVeg).reduce((s,e)=> s + (counts[e]||0), 0);
  balanceNote.textContent = `ØªÙˆØ²ÙŠØ¹ ØªØ§Ø±ÙŠØ®ÙŠ: Ø®Ø¶Ø§Ø± ${vegTotal} â€” Ù„Ø­ÙˆÙ… ${meatTotal}.`;

  // stats area
  const freqList = all.map(e=> `${e}Ã—${counts[e]||0}`).join(' | ');
  statsArea.innerHTML = `<div>ØªÙƒØ±Ø§Ø±Ø§Øª: ${freqList}</div><div style="margin-top:6px">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± (Ø®Ø·ÙˆØ§Øª Ù…Ù†Ø° Ø¢Ø®Ø±): ${all.map(e=> `${e}:${lastIndex[e]===999? 'ØºØ§Ø¦Ø¨': lastIndex[e]}`).join(' | ')}</div>`;

  // save hot
  localStorage.setItem('gc_ultimate_hot', JSON.stringify(hotManual));
}

/* ========= Ø£Ø²Ø±Ø§Ø± ÙˆØ¸ÙŠÙÙŠØ© ========= */
autoBtn.onclick = ()=>{
  const {top5} = computeTop5();
  // Ù†Ø¶ÙŠÙ ÙƒÙ„ top5 ÙƒÙ€ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© (ØªØ­Ø§ÙƒÙŠ Ù„Ø¹Ø¨ Ø°ÙƒÙŠ)
  top5.forEach(e=>{
    memory.push({emoji:e, t:Date.now()});
    if(memory.length>MEMORY_MAX) memory = memory.slice(-MEMORY_MAX);
  });
  localStorage.setItem('gc_ultimate_memory', JSON.stringify(memory));
  updateAll();
};
clearBtn.onclick = clearMemory;

exportBtn.onclick = ()=>{
  const data = {memory, hotManual, exportedAt: new Date().toISOString()};
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'greedycat-ultimate-export.json'; a.click(); URL.revokeObjectURL(url);
};

importBtn.onclick = ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = (ev)=>{
    const file = ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = JSON.parse(e.target.result);
        if(Array.isArray(data.memory)) memory = data.memory.slice(-MEMORY_MAX);
        if(data.hotManual) hotManual = data.hotManual;
        localStorage.setItem('gc_ultimate_memory', JSON.stringify(memory));
        localStorage.setItem('gc_ultimate_hot', JSON.stringify(hotManual));
        renderHotRow(); updateAll();
        alert('Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø§Ø¬Ø­!');
      }catch(err){ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
    };
    reader.readAsText(file);
  };
  inp.click();
};

/* ======= Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ======= */
function getName(e){ const it = allItems.find(x=>x.emoji===e); return it?it.name:''; }

/* ====== ØªÙ‡ÙŠØ¦Ø© ====== */
renderGrid(); renderHotRow(); updateAll();

/* Ù†ØµÙŠØ­Ø©: Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØºÙŠÙ‘Ø± Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„ÙƒØ´Ù (Ù…Ø«Ù„ thresholds)ØŒ Ù‚ÙˆÙ„Ù‘ÙŠ Ø£Ø¹Ø¯Ù„Ù‡Ø§ ÙÙˆØ±Ù‹Ø§. */
</script>
</body>
</html>
